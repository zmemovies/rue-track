<!DOCTYPE html>

<html lang="en">

<head>

<meta charset="UTF-8" />

<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>Rue Tracker</title>

<style>

  body {

    font-family: sans-serif;

    margin: 0;

    padding: 0;

    background: #fafafa;

    color: #222;

  }

  header {

    background: #ff7f50;

    color: white;

    padding: 1em;

    text-align: center;

    font-size: 1.4em;

    font-weight: bold;

  }

  nav {

    display: flex;

    background: #eee;

  }

  nav button {

    flex: 1;

    padding: 1em;

    border: none;

    background: #eee;

    cursor: pointer;

    font-size: 1em;

  }

  nav button.active {

    background: white;

    border-bottom: 3px solid #ff7f50;

  }

  main {

    padding: 1em;

  }

  .log-entry, .schedule-item, .command-row {

    background: white;

    margin: 0.5em 0;

    padding: 0.8em;

    border-radius: 6px;

    box-shadow: 0 2px 4px rgba(0,0,0,0.05);

  }

  .btn {

    background: #ff7f50;

    color: white;

    padding: 0.5em 1em;

    border: none;

    border-radius: 4px;

    cursor: pointer;

    margin-right: 0.5em;

  }

  .btn.delete {

    background: #d9534f;

  }

  .btn.small {

    padding: 0.3em 0.6em;

    font-size: 0.85em;

  }

  .green {

    background-color: #d4edda !important;

  }

</style>

</head>

<body>

<header>Rue Tracker</header>

<nav id="nav"></nav>

<main id="root"></main>



<script type="module">

import React, { useState, useEffect } from "https://esm.sh/react@18";

import ReactDOM from "https://esm.sh/react-dom@18";

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";



// === Supabase Config ===

const SUPABASE_URL = "https://dtkquldtmoboerwkgqqv.supabase.co";

const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR0a3F1bGR0bW9ib2Vyd2tncXF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MzgyOTUsImV4cCI6MjA3MDQxNDI5NX0.qOgFfvgA9xgzExYi52ZtXPOX6mLUgRPTNHiIgP0psH0";

const FAMILY_ID = "RUE_FAM";



const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);



// === Utility ===

const uid = (prefix = "id") => `${prefix}_${Math.random().toString(36).slice(2, 9)}`;

const formatTime = date => {

  let h = date.getHours();

  let m = date.getMinutes().toString().padStart(2, "0");

  let ampm = h >= 12 ? "PM" : "AM";

  h = h % 12 || 12;

  return `${h}:${m} ${ampm}`;

};

const now = () => new Date();

// === State Defaults ===

const defaultState = () => ({

  logs: [], // { id, type, at }

  schedule: [], // { id, at, type, done }

  trainingCommands: [

    { id: uid("cmd"), name: "Sit", totalSeconds: 0, learned: false, sessionHistory: [] },

    { id: uid("cmd"), name: "Down", totalSeconds: 0, learned: false, sessionHistory: [] },

  ],

});



// === Supabase Functions ===

async function loadState() {

  const { data, error } = await supabase

    .from("tracker_state")

    .select("state")

    .eq("family_id", FAMILY_ID)

    .single();

  if (error) {

    if (error.code === "PGRST116") {

      // no row yet, insert default

      const state = defaultState();

      await supabase.from("tracker_state").insert({ family_id: FAMILY_ID, state });

      return state;

    }

    console.error(error);

    return defaultState();

  }

  return data.state;

}



async function saveState(state) {

  await supabase

    .from("tracker_state")

    .upsert({ family_id: FAMILY_ID, state });

}



// === Components ===

function App() {

  const [state, setState] = useState(defaultState());

  const [tab, setTab] = useState("logs");

  const [loading, setLoading] = useState(true);



  useEffect(() => {

    loadState().then(s => {

      setState(s);

      setLoading(false);

    });

  }, []);



  useEffect(() => {

    if (!loading) {

      saveState(state);

    }

  }, [state, loading]);



  const addLog = (type, at = now()) => {

    const log = { id: uid("log"), type, at: at.toISOString() };

    let newLogs = [...state.logs, log];

    newLogs.sort((a, b) => new Date(a.at) - new Date(b.at));

    let newSchedule = [...state.schedule];

    if (type === "üíß") {

      // add pee attempt 80 min later if none exists

      if (!newSchedule.some(s => s.type === "üêïüí¶" && new Date(s.at) > now())) {

        const peeAt = new Date(at.getTime() + 80 * 60000);

        newSchedule.push({ id: uid("sch"), at: peeAt.toISOString(), type: "üêïüí¶", done: false });

      }

    }

    if (type === "üêïüí¶") {

      // remove future pee attempts

      newSchedule = newSchedule.filter(s => s.type !== "üêïüí¶" || new Date(s.at) <= now());

    }

    setState({ ...state, logs: newLogs, schedule: newSchedule });

  };



  const deleteLog = (id) => {

    setState({ ...state, logs: state.logs.filter(l => l.id !== id) });

  };



  const editLogTime = (id, newTime) => {

    setState({

      ...state,

      logs: state.logs.map(l =>

        l.id === id ? { ...l, at: newTime.toISOString() } : l

      )

    });

  };



  const markScheduleDone = (id) => {

    const item = state.schedule.find(s => s.id === id);

    if (!item) return;

    if (item.type === "üêïüí¶") {

      addLog("üêïüí¶", new Date(item.at));

    }

    if (item.type === "üçΩÔ∏è") {

      addLog("üçΩÔ∏è", new Date(item.at));

    }

    setState({

      ...state,

      schedule: state.schedule.map(s => s.id === id ? { ...s, done: true } : s)

    });

  };

  if (loading) return <div>Loading...</div>;



  return (

    <div>

      <nav>

        <button onClick={() => setTab("logs")} className={tab === "logs" ? "active" : ""}>Logs</button>

        <button onClick={() => setTab("schedule")} className={tab === "schedule" ? "active" : ""}>Schedule</button>

        <button onClick={() => setTab("training")} className={tab === "training" ? "active" : ""}>Training</button>

      </nav>

      {tab === "logs" && (

        <div>

          <h2>Logs</h2>

          <div>

            <button className="btn" onClick={() => addLog("üêïüí¶")}>Pee</button>

            <button className="btn" onClick={() => addLog("üí©")}>Poop</button>

            <button className="btn" onClick={() => addLog("üíß")}>Water</button>

            <button className="btn" onClick={() => addLog("üò¥")}>Sleep</button>

          </div>

          {state.logs.map(l => (

            <div key={l.id} className="log-entry">

              {l.type} ‚Äî {formatTime(new Date(l.at))}

              <button className="btn small delete" onClick={() => deleteLog(l.id)}>X</button>

              <button className="btn small" onClick={() => {

                const newTime = prompt("Enter new time (HH:MM AM/PM):");

                if (!newTime) return;

                const [time, ampm] = newTime.split(" ");

                let [hh, mm] = time.split(":").map(Number);

                if (ampm.toUpperCase() === "PM" && hh !== 12) hh += 12;

                if (ampm.toUpperCase() === "AM" && hh === 12) hh = 0;

                const d = new Date(l.at);

                d.setHours(hh, mm);

                editLogTime(l.id, d);

              }}>Edit</button>

            </div>

          ))}

        </div>

      )}

      {tab === "schedule" && (

        <div>

          <h2>Schedule</h2>

          {state.schedule

            .sort((a, b) => new Date(a.at) - new Date(b.at))

            .map(s => (

              <div key={s.id} className="schedule-item">

                {s.type} ‚Äî {formatTime(new Date(s.at))} {s.done ? "(done)" : ""}

                {!s.done && (

                  <button className="btn small" onClick={() => markScheduleDone(s.id)}>Done</button>

                )}

              </div>

            ))}

        </div>

      )}

      {tab === "training" && (

        <TrainingTab state={state} setState={setState} />

      )}

    </div>

  );

}



// === Training Tab ===

function TrainingTab({ state, setState }) {

  const startSession = (cmdId) => {

    const start = Date.now();

    const durPrompt = prompt("Enter minutes practiced:");

    if (!durPrompt) return;

    const minutes = parseInt(durPrompt);

    const successPrompt = prompt("Enter % successful responses:");

    if (!successPrompt) return;

    const pct = parseFloat(successPrompt) / 100;

    setState({

      ...state,

      trainingCommands: state.trainingCommands.map(c => {

        if (c.id === cmdId) {

          const newHistory = [...c.sessionHistory, { minutes, pct }];

          const avgPct = newHistory.slice(-3).reduce((a, b) => a + b.pct, 0) / newHistory.slice(-3).length;

          return {

            ...c,

            totalSeconds: c.totalSeconds + minutes * 60,

            learned: avgPct >= 0.75,

            sessionHistory: newHistory

          };

        }

        return c;

      })

    });

  };



  return (

    <div>

      <h2>Training</h2>

      {state.trainingCommands.map(c => (

        <div key={c.id} className={`command-row ${c.learned ? "green" : ""}`}>

          {c.name} ‚Äî {Math.round(c.totalSeconds / 60)} min {c.learned && "üéâ"}

          <button className="btn small" onClick={() => startSession(c.id)}>Train</button>

        </div>

      ))}

    </div>

  );

}

// === Render App ===

ReactDOM.createRoot(document.getElementById("root")).render(<App />);



</script>

</body>

</html>
