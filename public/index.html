<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rue Tracker</title>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; background:#fafafa; color:#222; }
    header { background:#ff7f50; color:#fff; padding:16px; text-align:center; font-weight:700; }
    nav { display:flex; background:#eee; }
    nav button { flex:1; padding:12px; border:0; background:#eee; cursor:pointer; font-size:16px; }
    nav button.active { background:#fff; border-bottom:3px solid #ff7f50; }
    main { padding:16px; }
    .log-entry,.schedule-item,.command-row { background:#fff; margin:8px 0; padding:12px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,.05); display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .btn { background:#ff7f50; color:#fff; border:0; border-radius:6px; padding:8px 12px; cursor:pointer; }
    .btn.small { padding:6px 10px; font-size:13px; }
    .btn.delete { background:#d9534f; }
    .green { background:#d4edda !important; }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    textarea, input, select { font:inherit; }
  </style>

  <!-- React / Supabase UMD + Babel (so JSX works without a build) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <header>Rue Tracker</header>
  <nav id="nav"></nav>
  <main id="root"></main>

  <script type="text/babel">
    const { useEffect, useState, useMemo } = React;

    // ─── Supabase config (your real values) ────────────────────────────────────
    const SUPABASE_URL = "https://dtkquldtmoboerwkgqqv.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR0a3F1bGR0bW9ib2Vyd2tncXF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MzgyOTUsImV4cCI6MjA3MDQxNDI5NX0.qOgFfvgA9xgzExYi52ZtXPOX6mLUgRPTNHiIgP0psH0";
    const FAMILY_ID = "RUE_FAM";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ─── Helpers ───────────────────────────────────────────────────────────────
    const uid = (p="id") => `${p}_${Math.random().toString(36).slice(2,9)}_${Date.now()}`;
    const now = () => new Date();
    const fmtTime = d => {
      let h = d.getHours(), m = String(d.getMinutes()).padStart(2,"0"), am = h>=12?"PM":"AM";
      h = h%12 || 12; return `${h}:${m} ${am}`;
    };

    // ─── Default state ─────────────────────────────────────────────────────────
    const defaultState = () => ({
      logs: [],               // [{id,type,atISO}]
      schedule: [],           // [{id,atISO,type,done}]
      trainingCommands: [
        { id: uid("cmd"), name: "Sit",  totalSeconds: 0, learned: false, sessionHistory: [] },
        { id: uid("cmd"), name: "Down", totalSeconds: 0, learned: false, sessionHistory: [] },
      ],
    });

    // ─── Cloud persistence (single-row state) ──────────────────────────────────
    async function loadState() {
      const { data, error } = await sb.from("tracker_state").select("state").eq("family_id", FAMILY_ID).single();
      if (error) {
        // PGRST116 = no row found
        if (error.code === "PGRST116") {
          const s = defaultState();
          await sb.from("tracker_state").insert({ family_id: FAMILY_ID, state: s });
          return s;
        }
        console.warn(error);
        return defaultState();
      }
      return data.state || defaultState();
    }
    async function saveState(state) {
      await sb.from("tracker_state").upsert({ family_id: FAMILY_ID, state });
    }

    // ─── App ───────────────────────────────────────────────────────────────────
    function App() {
      const [state, setState] = useState(defaultState());
      const [tab, setTab] = useState("logs");
      const [loading, setLoading] = useState(true);

      useEffect(() => { (async () => { const s = await loadState(); setState(s); setLoading(false); })(); }, []);
      useEffect(() => { if (!loading) saveState(state); }, [state, loading]);

      function addLog(type, at = now()) {
        const log = { id: uid("log"), type, at: at.toISOString() };
        const logs = [...state.logs, log].sort((a,b)=> new Date(a.at) - new Date(b.at));
        let schedule = [...state.schedule];

        if (type === "💧") {
          // schedule a pee attempt 80 min later if none is already pending in the future
          const pending = schedule.some(s => s.type === "🐕💦" && new Date(s.at) > now());
          if (!pending) schedule.push({ id: uid("sch"), at: new Date(at.getTime() + 80*60000).toISOString(), type: "🐕💦", done: false });
        }
        if (type === "🐕💦") {
          // clear future attempts after an actual attempt is logged
          schedule = schedule.filter(s => !(s.type === "🐕💦" && new Date(s.at) > now()));
        }
        setState({ ...state, logs, schedule });
      }

      function deleteLog(id) {
        setState({ ...state, logs: state.logs.filter(l => l.id !== id) });
      }

      function editLogTime(id, dateObj) {
        setState({
          ...state,
          logs: state.logs.map(l => l.id === id ? { ...l, at: dateObj.toISOString() } : l)
        });
      }

      function markScheduleDone(id) {
        const item = state.schedule.find(s => s.id === id);
        if (!item) return;
        if (item.type === "🐕💦") addLog("🐕💦", new Date(item.at));
        if (item.type === "🍽️") addLog("🍽️", new Date(item.at));
        setState({
          ...state,
          schedule: state.schedule.map(s => s.id === id ? { ...s, done: true } : s)
        });
      }

      if (loading) return <div style={{padding:"16px"}}>Loading…</div>;

      return (
        <div>
          <nav>
            <button onClick={()=>setTab("logs")} className={tab==="logs"?"active":""}>Logs</button>
            <button onClick={()=>setTab("schedule")} className={tab==="schedule"?"active":""}>Schedule</button>
            <button onClick={()=>setTab("training")} className={tab==="training"?"active":""}>Training</button>
          </nav>

          {tab==="logs" && (
            <section>
              <h2>Logs</h2>
              <div className="row" style={{marginBottom:8}}>
                <button className="btn" onClick={()=>addLog("🐕💦")}>Pee</button>
                <button className="btn" onClick={()=>addLog("💩")}>Poop</button>
                <button className="btn" onClick={()=>addLog("💧")}>Water</button>
                <button className="btn" onClick={()=>addLog("😴")}>Sleep</button>
              </div>

              {state.logs.map(l => (
                <div key={l.id} className="log-entry">
                  <div>{l.type} — {fmtTime(new Date(l.at))}</div>
                  <div className="row">
                    <button className="btn small" onClick={()=>{
                      const input = prompt("Enter new time (HH:MM AM/PM):");
                      if (!input) return;
                      const [t, ap] = input.trim().split(" ");
                      let [hh, mm] = t.split(":").map(Number);
                      if (ap?.toUpperCase()==="PM" && hh!==12) hh+=12;
                      if (ap?.toUpperCase()==="AM" && hh===12) hh=0;
                      const d = new Date(l.at);
                      d.setHours(hh||0, mm||0, 0, 0);
                      editLogTime(l.id, d);
                    }}>Edit</button>
                    <button className="btn small delete" onClick={()=>deleteLog(l.id)}>Delete</button>
                  </div>
                </div>
              ))}
              {!state.logs.length && <div>No logs yet.</div>}
            </section>
          )}

          {tab==="schedule" && (
            <section>
              <h2>Schedule</h2>
              {state.schedule
                .slice()
                .sort((a,b)=> new Date(a.at) - new Date(b.at))
                .map(s=>(
                  <div key={s.id} className="schedule-item">
                    <div>{s.type} — {fmtTime(new Date(s.at))} {s.done ? "(done)":""}</div>
                    {!s.done && <button className="btn small" onClick={()=>markScheduleDone(s.id)}>Done</button>}
                  </div>
                ))}
              {!state.schedule.length && <div>Nothing scheduled yet.</div>}
            </section>
          )}

          {tab==="training" && <TrainingTab state={state} setState={setState} />}
        </div>
      );
    }

    function TrainingTab({ state, setState }) {
      function startSession(cmdId) {
        const minsStr = prompt("Minutes practiced:");
        if (!minsStr) return;
        const minutes = Math.max(0, parseInt(minsStr,10) || 0);

        const successStr = prompt("Enter % successful responses:");
        if (!successStr) return;
        const pct = Math.min(1, Math.max(0, parseFloat(successStr)/100 || 0));

        setState({
          ...state,
          trainingCommands: state.trainingCommands.map(c=>{
            if (c.id !== cmdId) return c;
            const newHistory = [...c.sessionHistory, { minutes, pct }];
            const window = newHistory.slice(-3);
            const avg = window.reduce((a,b)=>a+(b.pct||0),0)/window.length;
            return {
              ...c,
              totalSeconds: c.totalSeconds + minutes*60,
              learned: avg >= 0.75,
              sessionHistory: newHistory
            };
          })
        });
      }

      return (
        <section>
          <h2>Training</h2>
          {state.trainingCommands.map(c=>(
            <div key={c.id} className={`command-row ${c.learned ? "green":""}`}>
              <div>{c.name} — {Math.round(c.totalSeconds/60)} min {c.learned && "🎉"}</div>
              <button className="btn small" onClick={()=>startSession(c.id)}>Train</button>
            </div>
          ))}
        </section>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
